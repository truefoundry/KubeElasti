# Add StartupProbe to delay startup & remove istio injection for more deterministic tests
# 
# Reason for adding startup probe delay is to test if KubeElasti checks the pod status, before switching modes.
# For this test, we remove istio dependency, and even make elastiService prometheus query to always signal a scale up.
apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - command: |
      kubectl --request-timeout=15s patch deployment target-deployment --type='json' -p '[
      {
        "op": "add",
        "path": "/spec/template/spec/containers/0/startupProbe",
        "value": {
          "tcpSocket": {
            "port": 80
          },
          "initialDelaySeconds": 20,
          "periodSeconds": 1
        }
      },
      {
        "op": "add",
        "path": "/spec/template/metadata/annotations/sidecar.istio.io~1inject",
        "value": "false"
      }]'
    namespaced: true
